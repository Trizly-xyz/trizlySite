<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Verifying…</title>
  <style>
    body { 
      background: #05060f; 
      color: white; 
      font-family: sans-serif; 
      text-align: center; 
      padding: 60px;
    }
  </style>
</head>
<body>

  <h2>Verifying your Discord identity…</h2>
  <p>Please wait a moment.</p>

  <script>
    // Get OAuth code from URL
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const state = params.get("state");

    if (!code) {
      document.body.innerHTML = "<h2>Missing OAuth code.</h2>";
      throw new Error("Missing code");
    }

    // Send to Cloudflare Worker to process Discord OAuth
    fetch("https://verify.trizly.xyz/verify/callback", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code, state })
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        document.body.innerHTML = "<h2>Verification Error</h2><p>" + data.error + "</p>";
        return;
      }

      if (!data.nextRobloxStartUrl) {
        document.body.innerHTML = "<h2>Error</h2><p>Missing Roblox authorization URL</p>";
        return;
      }

      // Redirect directly to Roblox OAuth (via worker)
      window.location.href = data.nextRobloxStartUrl;
    })
    .catch(err => {
      document.body.innerHTML = "<h2>Verification Failed</h2><p>" + err + "</p>";
    });
  </script>

</body>
</html>
